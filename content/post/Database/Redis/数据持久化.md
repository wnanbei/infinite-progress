---
title: "Redis 数据持久化策略"
date: 2021-06-06 00:00:00
categories:
  - Redis
tags:
  - Database
  - Redis
series:		
  - 面试大全
---

redis 提供了两种持久化的方式，分别是 `RDB(Redis DataBase)` 和 `AOF(Append Only File)`。

<!--more-->

## RDB

RDB，就是在不同的时间点，将 redis 存储的数据生成快照并存储到磁盘等介质上。

Redis 在进行 RDB 数据持久化的过程中，会先将数据写入到一个临时文件中，待持久化过程结束，才会用这个临时文件替换上次持久化好的文件。这种特性，让我们可以随时进行备份，因为快照文件总是完整可用的。

**优点：**

- Redis 会单独 fork 一个子进程进行持久化，不影响主进程性能。
- 大规模数据恢复更高效。
- 备份文件总是完整可用。

**缺点：**

- RDB 耗时较长，不够实时，在停机的时候会导致大量丢失数据。数据完整性较差。

## AOF

AOF，则是将 redis 执行过的所有写指令记录下来，在下次 redis 重新启动时，把这些写指令从前到后再重复执行一遍，实现数据恢复。开启 AOF 后，如果有写操作，如 SET 等，redis 就会追加到 AOF 文件的末尾。

默认的 AOF 持久化策略是每秒钟 fsync（指把缓存中的写指令记录到磁盘中）一次，因为在这种情况下，redis 仍然可以保持很好的处理性能，即使 redis 故障，也只会丢失最近 1 秒钟的数据。

**优点：**

- 丢失数据的可能性小。
- 有 Rewrite 机制可以控制 AOF 文件大小。
- 断电、磁盘满等问题都不会影响 AOF 文件的可用性。

**缺点：**

- AOF 文件会越来越大，占用较多空间。
- 数据恢复效率较慢。

### AOF Rewrite

Redis 提供了 AOF 文件重写（rewrite）机制，当 AOF 文件的大小超过所设定的阈值时，redis 就会启动 AOF 文件的内容压缩，只保留可以恢复数据的最小指令集。

例如调用了 100 次 INCR 指令，在 AOF 文件中可以用 rewrite 把这 100 条指令合并成一条 SET 指令。

**流程：**

1. redis 会创建（fork）一个重写子进程，首先读取现有的 AOF 文件，并将其包含的指令进行分析压缩并写入到一个临时文件中。
2. 同时，主工作进程会将新接收到的写指令一边累积到内存缓冲区中，一边继续写入到原有的 AOF 文件中，保证原有的 AOF 文件的可用性，避免在重写过程中出现意外。
3. 当重写子进程完成重写工作后，它会给父进程发一个信号，父进程收到信号后就会将内存中缓存的写指令追加到新 AOF 文件中。
4. 追加结束后，redis 就会用新 AOF 文件来代替旧 AOF 文件。

## 恢复数据

因为 RDB 会耗费较长时间，不够实时，在停机的时候会导致大量丢失数据，所以通常需要 AOF 配合同时使用。

在 Redis 实例重启时，使用 RDB 持久化文件重新构建内存，再使用 AOF 重放近期的操作指令来实现完整恢复重启之前的状态。