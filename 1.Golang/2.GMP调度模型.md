# GMP 调度模型

在 Go 中，线程是运行 goroutine 的实体，调度器的功能是把可运行的 goroutine 分配到工作线程上。

- `G` `Goroutine`

  用户级别的协程，我们在程序里用go关键字创建的协程。

- `P` `Processor`

  包含了 goroutine 运行的资源，M 必须和一个 P 关联才能运行 G。P 还包含自己的本地队列（local runqueue）来保存 G，这样可以避免竞争锁。

- `M` `Machine`

  指 go 语言对一个关联的内核线程的封装。

### 模型

![GMP模型.jpeg](../../assets/GMP%E6%A8%A1%E5%9E%8B.jpeg)

- `全局队列(Global Queue)`

  存放等待运行的 G。

- `P 的本地队列`

  同全局队列类似，存放的也是等待运行的 G，存的数量有限，不超过 256 个。

  新建 G 时，G 优先加入到 P 的本地队列，如果队列满了，则会把本地队列中一半的 G 移动到全局队列。

- `P 列表`

  所有的 P 都在程序启动时创建，并保存在数组中，最多有 GOMAXPROCS(可配置) 个。

- `M`

  线程想运行任务就得获取 P，从 P 的本地队列获取 G，P 队列为空时，M 也会尝试从全局队列拿一批 G 放到 P 的本地队列，或从其他 P 的本地队列偷一半放到自己 P 的本地队列。

  M 运行 G，G 执行之后，M 会从 P 获取下一个 G，不断重复下去。