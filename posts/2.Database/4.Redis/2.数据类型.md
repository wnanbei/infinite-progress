在 Redis 中，常用的 5 种数据类型和应用场景如下：

- `String`：缓存、计数器、限速器、分布式锁等。

- `List`：链表、队列、微博关注人时间轴列表等。

- `Hash`： 用户信息、Hash 表等。

- `Set`： 去重、赞、踩、共同好友等。

- `Sorted Set`：访问量排行榜、点击量排行榜等。

## redisObject

Redis 有一个核心的对象 `redisObject`，用来表示所有的 key。此对象中有 type 和 encoding 两个字段，用来表示 key 的类型和底层数据结构。

Redis 使用对象来表示数据库中的键和值，每次当我们在Redis的数据库中新创建一个键值对时，我们至少会创建两个对象，一个对象用作键值对的健(键对象)，另一个对象用作键值对的值(值对象)。

```c
Copytypedef struct redisObiect{
	//类型
	unsigned type:4;
	//编码
	unsigned encoding:4;
	//指向底层数据结构的指针
	void *ptr;
}
```

不同数据类型使用不同的数据结构以提升速度。每种数据类型都有一种或者多种数据结构来支撑。

![Redis 数据类型与数据结构关系](/Users/wnanbei/Documents/文档/infinity-progress/assets/Redis数据类型.png)

这样设计有两个好处：

1. 可以自由改进内部编码，而对外的数据结构和命令没有影响。
2. 多种内部编码实现可以在不同场景下发挥各自的优势，从而优化对象在不同场景下的使用效率。

使用以下命令可以查看 Key 具体的编码方式：

```redis
> object encoding keyName
```

## String

字符串。字符串对象的值可以是字符串、数字、甚至是二进制，最大不能超过 512MB。

主要底层数据结构为 `sds string`。

### 1. 字符串编码

字符串对象的内部编码有 3 种：`int`、`raw` 和 `embstr`。

1. 如果字符串对象保存的是可以用 `long` 类型表示的整数值，那么 Redis 会将整数值保存在字符串对象的 `ptr` 属性中，并将编码设置为 `int`。
2. 如果字符串对象保存的是一个字符串值，并且长度大于 32 字节，那么 Redis 将使用一个简单动态字符串 `SDS` 来保存，并将编码设置为 `raw`。
3. 如果字符串对象保存的是一个字符串值，并且长度小于等于 32 字节，那么 Redis 将使用一个简单动态字符串 `SDS` 来保存，并将编码设置为 `embstr`

`embstr` 编码是专门用于保存短字符串的一种优化编码方式，`raw` 编码会通过调用两次内存分配函数来分别分配两块空间来保存 `redisObject` 和 `SDS`，而 `embstr` 的不同之处在于会分配一块连续的内存空间来保存 `redisObject` 和 `SDS`。

`embstr` 编码的优点有以下几点：

- `embstr` 编码创建字符串对象所需的内存分配次数为一次
- `embstr` 编码的字符串对象释放内存也只需要调用一次内存释放函数
- `embstr` 编码的字符串对象的所有数据都保存在一块连续的内存里，可以更好的利用 CPU 缓存提升性能

## Hash

字典，键不可重复。

有两种不同的实现方式：

- `ziplist` - 满足以下条件时：
  - 元素个数少于 `hash-max-ziplist-entries(默认 512)`
  - 所有值都小于 `hash-max-ziplist-value(默认 64)`
- `hashtable` - 不满足 ziplist 条件时

## List

列表，元素有序且可以重复。

使用以下方式实现：

- `quicklist`

## Set

无序集合，存储不重复的元素。

有两种不同的实现方式：

- `intset` - 满足以下条件时：
  - 集合中元素都是整数
  - 元素个数少于 `set-maxintset-entries(默认 512)`
- `hashtable` - 不满足 intset 条件时

## Sorted Set

有序集合，使用 `score` 分数进行排序，允许分数相同，不允许集合元素值相同。分数相同时，按照元素值进行排序。

有两种不同的实现方式：

- `ziplist` - 满足以下条件时：
  - Set 键值对数量少于 128 个
  - 每个元素的长度都小于 64 字节
- `skiplist` - 不满足 ziplist 条件时

